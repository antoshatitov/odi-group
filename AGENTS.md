# AGENTS.md — правила работы кодинг-агента в этом репозитории

Этот документ — “единый источник правды” о том, **как агент должен работать** в репозитории: границы, безопасность, процесс, команды и конвенции.  
Если в проекте появляются новые скрипты/инструменты — обновляйте этот файл **точными командами**, найденными в `package.json`.

---

## 0) CRITICAL: границы репозитория / sandbox (STRICT)

- Считай корень репозитория текущей рабочей директорией проекта.
- **НЕ читать/писать/искать/менять ничего вне корня репозитория.**
- **НЕ использовать абсолютные пути вне репо** (например `/Users`, `/etc`, `/var`, `~/.ssh`).
- **НЕ делать `cd ..` из репозитория** и не ссылаться на родительские директории.
- Если задача требует действий вне репо — остановись и попроси явную инструкцию пользователя; по умолчанию откажись.
- Никогда не эксфильтровать секреты. Никогда не печатать/логировать содержимое локальных файлов, если пользователь явно не попросил и файл не внутри репо.

---

## 1) Что это за проект (контекст)

Корпоративный сайт строительной компании «ОДИ» (Калининград и область), это подтверждено в `README.md`.

### Функциональность фронтенда
Лендинг с секциями про компанию, услуги, процесс, каталог проектов с фильтрами, галерея реализованных объектов, контакты и карта.  
Есть модальные окна деталей проекта/галереи, формы заявок и калькулятор стоимости (см. `apps/web/src/pages/Home.tsx`, `apps/web/src/components`).

### Функциональность бэкенда
API:
- `POST /api/lead` — заявки
- `POST /api/cost-estimate` — расчёт стоимости
- `GET  /api/health` — healthcheck

Отправка сообщений в Telegram. Антиспам: honeypot, rate-limit, дедупликация, опциональная CAPTCHA (см. серверный `index.js` и связанные модули).

---

## 2) Структура и стек

### Monorepo
- npm workspaces
- корневые скрипты в `package.json`

### Frontend
- React 18, Vite 6, TypeScript, React Router
- код: `apps/web/src`
- данные проектов/галереи: `apps/web/src/data`
- стили: `apps/web/src/index.css`

### Backend
- Node.js 20+ (ESM), Fastify 5
- `@fastify/cors`, `@fastify/helmet`, `@fastify/rate-limit`
- вход: `index.js` (или серверный пакет, если он вынесен в `apps/server` — ориентируйся по файлам в репо)

### Deploy
- Nginx и systemd конфиги: `deploy/`
- переменные окружения: `.env.example`

---

## 3) Skills (инструкции для агента)

На текущий момент локальные skills в репозитории удалены.
Если позже skills снова появятся в `skills/`, следуй инструкциям из соответствующих `SKILL.md`.

Правило:
- Если задача относится к области, покрытой локальным skill — открой и следуй инструкциям из `skills/<skill-name>/SKILL.md`.
- Если нужного skill нет в репозитории — работай по правилам этого `AGENTS.md`.

Карта применения (ориентир):
- Локальная карта skills сейчас пустая (skills удалены).

Обновление:
- Не обновляй этот раздел только из-за “обнаружения” нового skill.
- Если в PR добавляются/удаляются skills (меняется папка `skills/`) — обнови карту применения в этом разделе в рамках того же PR.

---

## 4) Playwright MCP (ALLOWED) — для UI-проверок

Playwright MCP разрешён для UI checks и исследовательского тестирования.

Разрешено:
- открывать страницы и проверять layout/адаптив/визуальные регрессии
- скриншоты, DOM inspection, проверка интеракций (модалки, фильтры, навигация)
- использовать как для текущего сайта в dev, так и для референсов (если нужно)

Ограничения безопасности:
- **Только read-only browsing**: не совершать покупок/скачиваний исполняемых файлов/изменений аккаунтов.
- **Никогда не вводить креды/токены/персональные данные** на любых сайтах.
- **Не отправлять формы**, которые могут триггерить реальные действия (заявка/Telegram) — если задача не требует этого явно.
  - Для проверок предпочтительно: UI-валидация, мок/локальный режим, тестовый эндпоинт/флаг (если предусмотрен).
- Если в MCP есть allowlist хостов (например `--allowed-hosts`) — ограничь только нужными хостами.

---

## 5) Команды сборки/линта/дев-режима (используй реальные скрипты)

Инструменты: ESLint, Prettier, TypeScript, `@vitejs/plugin-react`.

### Основные команды (актуализируй по `package.json`)
- Установка зависимостей: `npm install`
- Dev (frontend): `npm run dev:web`
- Build (frontend): `npm run build:web`
- Lint (frontend): `npm run lint:web`
- Format (frontend): `npm run format:web`
- Preview (frontend): `npm run preview:web`
- Dev (server): `npm run dev:server` (если присутствует)
- Start (server): `npm run start:server` (если присутствует)
- Tests: если не настроены — так и писать, не выдумывать.

Правило: **не придумывай команды**. Если не уверен — проверь `package.json` и используй только существующие скрипты.

---

## 6) Рабочий процесс “1 сессия = 1 PR” (обязательный)

Любая задача выполняется в одной сессии и оформляется как один PR.  
**Не смешивать разные темы/рефакторинги/апдейты в одном PR.**

### 6.1 Branch Naming (Agent-generated)
Агент генерирует имя ветки автоматически, если пользователь не задал имя явно.

Разрешённые префиксы веток:
- `feat/...` — new features
- `fix/...` — bug fixes
- `chore/...` — maintenance/tooling
- `refactor/...` — non-functional improvements
- `docs/...` — documentation only
- `test/...` — tests only

Правила:
- `kebab-case`
- коротко и по сути
- без пробелов
- не использовать `:` в имени ветки (в Git это недопустимый формат для branch naming policy)

Примеры:
- `fix/modal-scroll-lock`
- `feat/calculator-validation`
- `chore/update-eslint-config`

### 6.2 Commits (Conventional Commits)
Использовать Conventional Commits:
- `feat: ...`
- `fix: ...`
- `chore: ...`
- `refactor: ...`
- `docs: ...`
- `test: ...`

Требования к subject:
- до 72 символов
- повелительное наклонение
- body опционален (добавлять, если «почему» не очевидно)

Коммиты должны быть небольшими и логичными. Избегай `wip` в финале (в процессе — по возможности тоже избегать).

**STRICT: No AI attribution footers**
Никогда не добавлять:
- `Co-Authored-By: Codex`
- `Generated with Codex`
- `Generated with...`
- любые аналогичные AI-attribution подписи в commit/PR/issues/docs/выводах

### 6.3 The only allowed change flow
Когда изменения готовы и пользователь явно попросил commit/push/PR:
1) убедиться, что текущая ветка **не** `main`;
2) создать новую ветку (agent-generated name), если нужно;
3) выполнить commit в эту ветку;
4) выполнить push этой ветки;
5) открыть PR.

Одна задача → одна ветка → один PR.

Запрещено пушить в `main` при любом сценарии работы агента.

### 6.4 PR Requirements (Mandatory)
PR-описание должно включать все секции:
- **Summary** — что изменено (bullets)
- **Why** — мотивация/ожидаемое поведение
- **Changes** — ключевые файлы/модули и что сделано
- **How to test** — точные команды и/или ручные шаги + ожидаемый результат
- **Verification** — что из lint/typecheck/tests/build запущено; если не запускалось, почему
- **Screenshots / Video** — для UI-изменений
- **Risk & Rollback** — уровень риска и безопасный способ отката

Агент сначала показывает PR summary в чате, затем создаёт PR и после этого публикует ссылку на PR.

### 6.5 Merging
- Агент **никогда не мержит** PR.
- Решение о merge принимает только пользователь.

---

## 7) Протокол выполнения задачи (строго 4 фазы)

Агент обязан придерживаться этого протокола на каждой задаче:

### Фаза A — План (до правок)
Сформулировать план:
- какие файлы/модули будут затронуты
- какие шаги будут выполнены
- какие риски/краевые случаи проверить (особенно формы/модалки/API)

### Фаза B — Изменения + подробный отчёт
После внесения правок:
- список изменённых файлов
- что именно изменено и почему
- что намеренно НЕ менялось (если рядом было “соблазнительно улучшить”)

### Фаза C — Самопроверка
Минимум:
- `npm run dev:web` и ручная проверка сценариев
- если есть lint/typecheck/build — прогнать релевантные команды
- для UI-задач: подтверждение через Playwright MCP

### Фаза D — Итоговый отчёт
В конце:
- кратко “что изменено”
- “как проверить” (пошагово)
- важные допущения/ограничения/известные риски

---

## 8) Границы и правила безопасности (проект-специфично, строго)

### 8.1 Секреты, токены, персональные данные
Запрещено:
- коммитить реальные значения токенов/ключей/`chat_id`/CAPTCHA-ключей
- создавать и коммитить `.env` (если пользователь явно не попросил)
- логировать ПДн, содержимое заявок, телефоны, адреса, токены

Разрешено:
- обновлять `.env.example` (документация) и использовать плейсхолдеры вида `YOUR_TELEGRAM_TOKEN_HERE`

### 8.2 API/безопасность сервера
Запрещено без явного запроса:
- ослаблять/отключать `@fastify/helmet`, `@fastify/rate-limit`, антиспам-механики (honeypot/дедупликация)
- расширять CORS “всем всё можно”, если задача этого прямо не требует
- выдавать наружу стеки/секреты в ошибках и логах

Обязательно при правках API:
- валидировать входные данные на границе (до бизнес-логики)
- сохранять контракт эндпоинтов, если не согласовано изменение
- не раскрывать подробные внутренние ошибки клиенту

### 8.3 Deploy и инфраструктура (`deploy/`)
Файлы `deploy/` менять **только** если задача прямо про деплой/инфраструктуру.  
Запрещено “по пути” менять nginx/systemd, порты, users, пути, перезапуски.

### 8.4 Зависимости
Запрещено без явного запроса:
- массово обновлять версии зависимостей
- добавлять новую зависимость “для удобства”
- менять `package-lock.json` без причины

Если зависимость всё же нужна:
- объяснить зачем без неё нельзя
- выбрать минимальную альтернативу
- зафиксировать, как это влияет на сборку/команды/безопасность

### 8.5 Фронтенд-ограничения (качество продукта)
- Не ломать ключевые секции лендинга и SEO-контент.
- Не ухудшать доступность: корректный focus, закрытие модалок (ESC/оверлей), навигация с клавиатуры (если реализовано).
- Не добавлять тяжёлые библиотеки ради мелких UI-эффектов.

---

## 9) UI regression checklist (перед завершением UI-задач)

Проверить вручную (и/или через Playwright MCP):
- лендинг грузится и секции на месте
- каталог проектов: фильтры работают, список корректный
- галерея: открытие/перелистывание, корректные изображения
- модалки проекта/галереи: открытие/закрытие/скролл/ESC
- формы заявок: валидация, состояния loading/success/error (без реальной отправки, если не нужно)
- калькулятор стоимости: базовый сценарий ввода и расчёта
- адаптив: mobile/tablet/desktop (минимум — ключевые брейкпоинты)

---

## 10) Код-стайл и конвенции

### Imports
- Предпочитай абсолютные импорты, если проект это поддерживает.
- Группируй импорты: standard lib → third-party → local.
- 1 пустая строка между группами.
- Не оставляй неиспользуемые импорты.

### Formatting
- Длина строки: до 100 символов (если инструмент не задаёт иначе).
- Отступы: 2 пробела для JS/TS/JSON/YAML/Markdown-код-блоков.
- Предпочитай trailing commas, где поддерживается.
- Prettier (ориентир): `printWidth 100`, `singleQuote true`, `trailingComma all`, `semi false`.
- Используй ESM там, где это принятая конвенция проекта (`type: module`).

### TypeScript
- Явные типы на границах модулей и публичных API.
- Не использовать `any`; вместо него `unknown` + narrowing.
- Типы держать рядом с использованием, переиспользуемые вынести аккуратно.

### Error handling & logging
- Guard clauses и ранние возвраты — предпочтительнее глубокой вложенности.
- Не глотать ошибки молча.
- Логи — только полезные, без секретов и ПДн.

### Документация
- Если добавлены новые команды/переменные окружения — обновить README/`.env.example`/документацию.

---

## 11) Repo discovery checklist (когда появляются новые файлы/инструменты)

- Проверить build/test конфиги: `package.json`, `tsconfig*`, конфиги ESLint/Prettier, CI workflow.
- Зафиксировать точные команды build/lint/format/test (в разделе 5).
- Узнать single-test флаги, если добавятся тесты, и записать явно.
- Зафиксировать требования к runtime/engines (Node и т.д.), если они меняются.
- Учесть внешние сервисы/переменные окружения и описать через `.env.example`.

---

## 12) Workspace hygiene

- Не удалять файлы/изменения без явного запроса.
- Избегать разрушительных команд (`rm -rf`, дисковые операции, privilege escalation).
- Избегать разрушительных git-команд.
- Правки — минимальные и строго по задаче.
- Всегда работать **внутри repo root** (см. sandbox правила).

---

## 13) Быстрый чеклист перед “готово”

- [ ] План опубликован до изменений
- [ ] Изменения минимальны и по задаче (не смешано несколько тем)
- [ ] Нет секретов/ключей/ПДн в коде и логах
- [ ] `npm run dev:web` запускается, базовые сценарии работают
- [ ] Если есть lint/typecheck/build — релевантные проверки пройдены
- [ ] Для UI-задач выполнен UI regression checklist + при необходимости Playwright MCP
- [ ] Итоговый отчёт: “что изменено и как проверить” готов
